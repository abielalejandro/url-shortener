services:
  consul:
    image: hashicorp/consul:1.15.4
    container_name: consul-server
    hostname: consul-server
    restart: always
    dns:
      - 8.8.8.8
      - 1.1.1.1
      - 10.50.0.2
    environment:
      - CONSUL_ALLOW_PRIVILEGED_PORTS    
    volumes:
     - ./consul/server.json:/etc/consul.d/server.json:ro
    networks:
      shortener:
        ipv4_address: 10.50.0.2
    ports:
      - "8500:8500"
      - "8600:8600/tcp"
      - "8600:8600/udp"
    command: "agent -config-file /etc/consul.d/server.json"

  # Redis storage for state persistence
  redis:
    image: redis:6.0-alpine
    restart: always
    container_name: redis-server
    ports:
      - "6379:6379"
    volumes:
      - "redisdata:/data"
    networks:
      - shortener
      
  tgs_service:
    restart: on-failure
    build:
      context: ../tgs-service
      dockerfile: ./docker/Dockerfile.consul
      args:
        PORT: $PORT  
    dns:
      - 10.50.0.2
    environment:
      - API_TYPE=$API_TYPE    
    cap_add:
      - "NET_ADMIN"
    volumes:
     - ./consul/client.json:/etc/consul.d/client.json:ro
    networks:
      - shortener
  #shortener_service:
  #  build:
  #    context: ../shortener-service
  #    dockerfile: Dockerfile
  #  ports:
  #    - "8080:8080"       
  #  networks:
  #    - shortener

networks:
  shortener:
    ipam:
      config:
        - subnet: 10.50.0.0/16
    driver: bridge

volumes:
  redisdata:
